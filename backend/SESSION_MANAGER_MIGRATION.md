# –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ SessionManager V2 (MongoDB-–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)

## üéØ –ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è V2

### 1. ‚úÖ TTL –∏–Ω–¥–µ–∫—Å (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞)
```python
# V1: –†—É—á–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç
await session_manager.cleanup_old_sessions(timeout_minutes=15)

# V2: MongoDB –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
await self.sessions.create_index("timestamp", expireAfterSeconds=900)
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ù–µ –Ω—É–∂–µ–Ω –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç
- –ú–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ CPU
- –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ (–¥–∞–∂–µ –µ—Å–ª–∏ –±–æ—Ç —É–ø–∞–ª)

---

### 2. ‚úÖ –ê—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–±–µ–∑ race conditions)

#### –ü—Ä–æ–±–ª–µ–º–∞ –≤ V1:
```python
# ‚ùå V1: –î–≤–∞ –∑–∞–ø—Ä–æ—Å–∞ = race condition –≤–æ–∑–º–æ–∂–µ–Ω
session = await self.get_session(user_id)  # –ó–∞–ø—Ä–æ—Å 1
existing_data = session.get("temp_data", {})
existing_data.update(data)
await self.sessions.update_one(...)  # –ó–∞–ø—Ä–æ—Å 2

# –ú–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ –¥—Ä—É–≥–æ–π –ø—Ä–æ—Ü–µ—Å—Å –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ!
```

#### –†–µ—à–µ–Ω–∏–µ –≤ V2:
```python
# ‚úÖ V2: –û–¥–∏–Ω –∞—Ç–æ–º–∞—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å
await self.sessions.find_one_and_update(
    {"user_id": user_id},
    {
        "$set": {
            "temp_data.from_name": "John",  # –ü—Ä—è–º–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—è
            "temp_data.weight": 5,
            "timestamp": datetime.now(timezone.utc)
        }
    },
    return_document=True
)
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è MongoDB
- –ù–µ—Ç race conditions
- –ë—ã—Å—Ç—Ä–µ–µ (1 –∑–∞–ø—Ä–æ—Å –≤–º–µ—Å—Ç–æ 2)

---

### 3. ‚úÖ find_one_and_update –≤–º–µ—Å—Ç–æ update_one

```python
# V1: –ù–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç
result = await self.sessions.update_one(...)
# –ù—É–∂–µ–Ω –≤—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ

# V2: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç —Å—Ä–∞–∑—É
session = await self.sessions.find_one_and_update(..., return_document=True)
# –í—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ –æ–¥–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ!
```

---

### 4. ‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

```python
# V2: –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π
async with await self.db.client.start_session() as session:
    async with session.start_transaction():
        # 1. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–µ–π–±–ª
        await self.completed_labels.insert_one(label_record, session=session)
        # 2. –£–¥–∞–ª–∏—Ç—å —Å–µ—Å—Å–∏—é
        await self.sessions.delete_one({"user_id": user_id}, session=session)
        
# –õ–∏–±–æ –æ–±–∞ –¥–µ–π—Å—Ç–≤–∏—è –≤—ã–ø–æ–ª–Ω—è—Ç—Å—è, –ª–∏–±–æ –Ω–∏ –æ–¥–Ω–æ (–∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å)
```

---

## üìä –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞

| –ê—Å–ø–µ–∫—Ç | V1 (—Ç–µ–∫—É—â–∏–π) | V2 (—É–ª—É—á—à–µ–Ω–Ω—ã–π) |
|--------|--------------|-----------------|
| **TTL –∏–Ω–¥–µ–∫—Å** | ‚ùå –ù–µ—Ç | ‚úÖ –ï—Å—Ç—å |
| **–ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞** | ‚ö†Ô∏è –†—É—á–Ω–∞—è (–∫–∞–∂–¥—ã–µ 10 –º–∏–Ω) | ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è (MongoDB) |
| **–ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å** | ‚ùå get + update (2 –∑–∞–ø—Ä–æ—Å–∞) | ‚úÖ find_one_and_update (1 –∑–∞–ø—Ä–æ—Å) |
| **Race conditions** | ‚ö†Ô∏è –í–æ–∑–º–æ–∂–Ω—ã | ‚úÖ –ò—Å–∫–ª—é—á–µ–Ω—ã |
| **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏** | ‚ùå –ù–µ—Ç | ‚úÖ –î–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π |
| **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** | ‚ö†Ô∏è 2 –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ update | ‚úÖ 1 –∑–∞–ø—Ä–æ—Å |
| **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** | ‚ö†Ô∏è –ó–∞–≤–∏—Å–∏—Ç –æ—Ç –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏ | ‚úÖ MongoDB –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç |

---

## üöÄ –ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ë—ã—Å—Ç—Ä–∞—è –º–∏–≥—Ä–∞—Ü–∏—è (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

**–ü–ª—é—Å—ã:** –ü–æ–ª—É—á–∞–µ—Ç–µ –≤—Å–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Å—Ä–∞–∑—É
**–ú–∏–Ω—É—Å—ã:** –ù—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –≤–µ—Å—å –∫–æ–¥

**–®–∞–≥–∏:**
1. –ó–∞–º–µ–Ω–∏—Ç—å `from session_manager import SessionManager` ‚Üí `from session_manager_v2 import SessionManagerV2`
2. –û–±–Ω–æ–≤–∏—Ç—å –≤—ã–∑–æ–≤—ã:
   - `create_session()` ‚Üí `get_or_create_session()`
   - `update_session()` ‚Üí `update_session_atomic()`
3. –£–¥–∞–ª–∏—Ç—å –≤—ã–∑–æ–≤—ã `cleanup_old_sessions()` (TTL –¥–µ–ª–∞–µ—Ç —ç—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è

**–ü–ª—é—Å—ã:** –ú–µ–Ω—å—à–µ —Ä–∏—Å–∫–∞
**–ú–∏–Ω—É—Å—ã:** –î–æ–ª—å—à–µ

**–®–∞–≥–∏:**
1. –î–æ–±–∞–≤–∏—Ç—å TTL –∏–Ω–¥–µ–∫—Å –≤ V1:
```python
# –í _create_indexes() –¥–æ–±–∞–≤–∏—Ç—å:
await self.sessions.create_index("timestamp", expireAfterSeconds=900)
```

2. –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –∑–∞–º–µ–Ω—è—Ç—å –º–µ—Ç–æ–¥—ã –Ω–∞ –∞—Ç–æ–º–∞—Ä–Ω—ã–µ –≤–µ—Ä—Å–∏–∏

3. –ö–æ–≥–¥–∞ –≥–æ—Ç–æ–≤—ã - –ø–æ–ª–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ V2

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è

### –ö–æ–≥–¥–∞ –ù–£–ñ–ù–ê –º–∏–≥—Ä–∞—Ü–∏—è:
- ‚úÖ –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ race conditions (–¥–∞–Ω–Ω—ã–µ —Ç–µ—Ä—è—é—Ç—Å—è)
- ‚úÖ –ï—Å–ª–∏ –≤—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ (–º–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ)
- ‚úÖ –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å

### –ö–æ–≥–¥–∞ –ù–ï –°–†–û–ß–ù–û:
- ‚ö†Ô∏è –ï—Å–ª–∏ –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ
- ‚ö†Ô∏è –ï—Å–ª–∏ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∏–∑–∫–∞—è (<10 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
- ‚ö†Ô∏è –ï—Å–ª–∏ –Ω–µ—Ç –±–∞–≥–æ–≤ —Å –ø–æ—Ç–µ—Ä–µ–π –¥–∞–Ω–Ω—ã—Ö

---

## üí° –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç (—Ç–æ–ª—å–∫–æ TTL –∏–Ω–¥–µ–∫—Å)

–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∏:

```python
# –í session_manager.py, —Å—Ç—Ä–æ–∫–∞ 23-32, –∑–∞–º–µ–Ω–∏—Ç—å:

async def _create_indexes(self):
    """Create MongoDB indexes for fast queries"""
    try:
        await self.sessions.create_index("user_id", unique=True)
        
        # ADD THIS: TTL index –¥–ª—è –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∏
        await self.sessions.create_index(
            "timestamp", 
            expireAfterSeconds=900  # 15 –º–∏–Ω—É—Ç
        )
        
        await self.completed_labels.create_index("user_id")
        await self.completed_labels.create_index("created_at")
        logger.info("‚úÖ Session indexes created (including TTL)")
    except Exception as e:
        logger.error(f"Error creating session indexes: {e}")
```

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å:
- –í—ã–∑–æ–≤—ã `cleanup_old_sessions()` –∏–∑ server.py
- –§—É–Ω–∫—Ü–∏—é `cleanup_sessions_periodically()` (—Å—Ç—Ä–æ–∫–∞ 8203)

**–≠–∫–æ–Ω–æ–º–∏—è:** CPU + –º–µ–Ω—å—à–µ –∫–æ–¥–∞, MongoDB —Å–∞–º –≤—Å—ë —Å–¥–µ–ª–∞–µ—Ç.

---

## üîç –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ TTL —Ä–∞–±–æ—Ç–∞–µ—Ç

```python
# –í MongoDB shell –∏–ª–∏ —á–µ—Ä–µ–∑ –∫–æ–¥:
db.user_sessions.getIndexes()

# –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–Ω–¥–µ–∫—Å:
{
    "v": 2,
    "key": {"timestamp": 1},
    "name": "timestamp_1",
    "expireAfterSeconds": 900  # ‚Üê –≠—Ç–æ TTL!
}
```

–ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ `expireAfterSeconds` - TTL —Ä–∞–±–æ—Ç–∞–µ—Ç! ‚úÖ
